{% extends 'base.html' %} {% load static %} {% block content %}
<!-- Hero Section -->
<div
  class="relative bg-gradient-to-br from-emerald-500 to-indigo-600 rounded-2xl shadow-xl overflow-hidden p-8 md:p-12 mb-12 text-white"
>
  <div class="relative z-10 text-center">
    <h1 class="text-4xl md:text-5xl font-bold mb-4">Gear Up for Greatness</h1>
    <p class="text-lg text-emerald-100 max-w-2xl mx-auto">
      Find the best athletic apparel and footwear to elevate your game.
    </p>
    <p class="text-sm mt-2 text-indigo-200">Muhamad Hakim Nizami / 2406399485</p>
  </div>
  <div class="absolute inset-0 bg-black/20"></div>
</div>

<!-- Featured Products -->
<section class="mb-16">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-bold text-gray-800">Featured Products</h2>
    <a href="#all-products" class="text-emerald-600 hover:text-emerald-700 transition-colors"
      >View All &rarr;</a
    >
  </div>
  <div
    id="featured-grid"
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"
  ></div>
</section>

<!-- All Products Section -->
<section id="all-products">
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-xl border border-gray-200 p-4 shadow-sm"
  >
    <div class="flex flex-wrap items-center gap-3 mb-4 sm:mb-0">
      <button
        data-filter-type="ownership"
        data-filter-value="all"
        class="filter-btn bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium transition-colors hover:bg-emerald-600"
      >
        All Products
      </button>
      <button
        data-filter-type="ownership"
        data-filter-value="my"
        class="filter-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg font-medium transition-colors hover:bg-emerald-500 hover:text-white"
      >
        My Products
      </button>
      <div class="h-6 w-px bg-gray-200 hidden sm:block"></div>
      <button
        data-filter-type="category"
        data-filter-value="ALL"
        class="filter-btn-category bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full font-medium text-sm transition-colors hover:bg-emerald-200"
      >
        All
      </button>
      <button
        data-filter-type="category"
        data-filter-value="FOOTWEAR"
        class="filter-btn-category bg-white text-gray-600 px-3 py-1 rounded-full font-medium text-sm transition-colors hover:bg-emerald-100"
      >
        Footwear
      </button>
      <button
        data-filter-type="category"
        data-filter-value="JERSEY"
        class="filter-btn-category bg-white text-gray-600 px-3 py-1 rounded-full font-medium text-sm transition-colors hover:bg-emerald-100"
      >
        Jersey
      </button>
      <button
        data-filter-type="category"
        data-filter-value="SHORTS"
        class="filter-btn-category bg-white text-gray-600 px-3 py-1 rounded-full font-medium text-sm transition-colors hover:bg-emerald-100"
      >
        Shorts
      </button>
    </div>
    <button
      onclick="openAddModal()"
      class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors flex items-center gap-2"
    >
      <i data-lucide="plus-circle" class="w-5 h-5"></i>
      Add Product
    </button>
  </div>

  <!-- Loading State -->
  <div id="loading" class="text-center py-12 hidden">
    <svg
      class="animate-spin h-8 w-8 text-emerald-500 inline-block"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
    >
      <circle
        class="opacity-25"
        cx="12"
        cy="12"
        r="10"
        stroke="currentColor"
        stroke-width="4"
      ></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-gray-600 mt-3">Loading products...</p>
  </div>

  <!-- Error State -->
  <div
    id="error"
    class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"
    role="alert"
  >
    <strong class="font-bold">Error!</strong>
    <span class="block sm:inline">Could not load products. Please try again later.</span>
  </div>

  <!-- Grid -->
  <div
    id="grid"
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 hidden"
  ></div>

  <!-- Empty State -->
  <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
    <div class="w-32 h-32 mx-auto mb-4">
      <img
        src="{% static 'image/no-product.png' %}"
        alt="No products available"
        class="w-full h-full object-contain"
      />
    </div>
    <h3 class="text-xl font-semibold text-gray-800 mb-2">No products found</h3>
    <p class="text-gray-500 mb-6 max-w-sm mx-auto">
      Try adjusting your filters or be the first to add a product.
    </p>
    <button
      onclick="openAddModal()"
      class="inline-flex items-center px-6 py-3 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors"
    >
      <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
      Add Product
    </button>
  </div>
</section>

{% endblock %} {% block scripts %}
<script>
  function showDeleteModal() {
    const modal = document.getElementById("deleteConfirmationModal");
    const panel = modal.querySelector(".modal-panel");

    modal.classList.remove("hidden");
    // allow one frame so the transition can run
    requestAnimationFrame(() => {
      panel.classList.remove("opacity-0", "scale-95");
      panel.classList.add("opacity-100", "scale-100");
    });
  }

  function hideDeleteModal() {
    const modal = document.getElementById("deleteConfirmationModal");
    const panel = modal.querySelector(".modal-panel");

    panel.classList.add("opacity-0", "scale-95");
    panel.classList.remove("opacity-100", "scale-100");

    panel.addEventListener(
      "transitionend",
      () => {
        modal.classList.add("hidden");
      },
      { once: true }
    );
  }

  function openDeleteModal(productId) {
    showDeleteModal();
    const confirmDeleteButton = document.getElementById("confirmDeleteButton");
    confirmDeleteButton.onclick = async function () {
      const url = `/product/delete/${productId}/`;
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        const result = await response.json();
        if (result.status === "success") {
          hideDeleteModal();
          showToast("Success", "Product deleted successfully!", "success");
          // Re-fetch products after deletion
          if (typeof fetchProductsFromServer === "function") {
            fetchProductsFromServer();
          } else {
            window.location.reload();
          }
        } else {
          hideDeleteModal();
          showToast("Error", result.message || "An error occurred.", "error");
        }
      } catch (error) {
        hideDeleteModal();
        showToast("Error", "An unexpected network error occurred.", "error");
      }
    };
  }

  function openEditModal(productId) {
    const product = allProductsData.find((p) => p.id === productId);
    if (!product) {
      showToast("Error", "Product not found.", "error");
      return;
    }
    const productForm = document.getElementById("productForm");
    productForm.reset();
    document.getElementById("productId").value = product.id;
    document.getElementById("name").value = product.name;
    document.getElementById("price").value = product.price;
    document.getElementById("description").value = product.description;
    document.getElementById("category").value = product.category;
    document.getElementById("thumbnail").value = product.thumbnail;
    document.getElementById("stock").value = product.stock;
    document.getElementById("is_featured").checked = product.is_featured;

    document.getElementById("modal-title").innerText = "Edit Product";
    document.getElementById("modal-description").innerText = "Update the details of the product.";
    document.getElementById("submitProduct").innerText = "Save Changes";
    document
      .getElementById("submitProduct")
      .classList.remove("bg-emerald-500", "hover:bg-emerald-600");
    document.getElementById("submitProduct").classList.add("bg-indigo-500", "hover:bg-indigo-600");
    showModal();
  }

  document.addEventListener("DOMContentLoaded", function () {
    // --- CONFIGURATION ---
    const PRODUCT_API_ENDPOINT = "/json/";
    const ADD_PRODUCT_URL = "/product/add/";
    const EDIT_PRODUCT_BASE_URL = "/product/edit/";
    const DELETE_PRODUCT_BASE_URL = "/product/delete/";
    const CURRENT_USER_ID = document.body.dataset.userId || "";

    // --- DOM ELEMENTS ---
    const loadingSpinner = document.getElementById("loading");
    const errorMessage = document.getElementById("error");
    const emptyStateDisplay = document.getElementById("empty");
    const productGridContainer = document.getElementById("grid");
    const featuredGridContainer = document.getElementById("featured-grid");
    const productForm = document.getElementById("productForm");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const categoryFilterButtons = document.querySelectorAll(".filter-btn-category");
    const cartCount = document.getElementById("cart-count");

    // --- STATE ---
    let activeOwnershipFilter = "all";
    let activeCategoryFilter = "ALL";
    let allProductsData = [];

    // --- FUNCTIONS ---
    function displayPageSection({
      showLoading = false,
      showError = false,
      showEmpty = false,
      showGrid = false,
    }) {
      loadingSpinner.classList.toggle("hidden", !showLoading);
      errorMessage.classList.toggle("hidden", !showError);
      emptyStateDisplay.classList.toggle("hidden", !showEmpty);
      productGridContainer.classList.toggle("hidden", !showGrid);
    }

    function openAddModal() {
      productForm.reset();
      document.getElementById("productId").value = "";
      document.getElementById("modal-title").innerText = "Create New Product";
      document.getElementById("modal-description").innerText =
        "Fill in the details to add a new product.";
      document.getElementById("submitProduct").innerText = "Add Product";
      document
        .getElementById("submitProduct")
        .classList.remove("bg-indigo-500", "hover:bg-indigo-600");
      document
        .getElementById("submitProduct")
        .classList.add("bg-emerald-500", "hover:bg-emerald-600");
      showModal();
    }
    window.openAddModal = openAddModal;

    function buildProductCardElement(productItem) {
      const productElement = document.createElement("div");
      productElement.className =
        "bg-white rounded-xl shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 flex flex-col group";

      const detailLink = `/product/${productItem.id}/`;

      const thumbnailHtml = productItem.thumbnail
        ? `<img src='${productItem.thumbnail}' alt='${productItem.name}' class='w-full h-56 object-cover group-hover:scale-105 transition-transform duration-300'>`
        : `<div class='w-full h-56 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'><i data-lucide="image-off" class="text-gray-400 w-16 h-16"></i></div>`;

      const editDeleteButtons =
        CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(productItem.user_id)
          ? `<div class='absolute top-3 right-3 flex gap-2 opacity-100 transition-opacity duration-300'>
              <button data-action="edit" data-product-id="${productItem.id}" class="z-10 relative bg-white/80 backdrop-blur-sm rounded-full p-2 hover:bg-white transition-colors">
                <i data-lucide="square-pen" class="text-indigo-500 w-5 h-5 pointer-events-none"></i>
              </button>
              <button data-action="delete" data-product-id="${productItem.id}" class="z-10 relative bg-white/80 backdrop-blur-sm rounded-full p-2 hover:bg-white transition-colors">
                <i data-lucide="trash-2" class="text-red-500 w-5 h-5 pointer-events-none"></i>
              </button>
            </div>`
          : "";

      productElement.innerHTML = `
        <a href="${detailLink}" class="flex flex-col flex-grow">
          <div class="relative overflow-hidden">
            ${thumbnailHtml}
            ${editDeleteButtons}
          </div>
          <div class="p-5 flex flex-col flex-grow">
            <h3 class="text-lg font-semibold text-gray-800 truncate">${productItem.name}</h3>
            <p class="text-emerald-600 text-sm mt-1 font-medium">${productItem.category}</p>
            <div class="flex-grow"></div>
            <div class="flex justify-between items-center mt-4">
              <p class="text-xl font-bold text-indigo-600">Rp${productItem.price.toLocaleString(
                "id-ID"
              )}</p>
              ${
                CURRENT_USER_ID && Number(CURRENT_USER_ID) !== Number(productItem.user_id)
                  ? `<button onclick="event.stopPropagation(); event.preventDefault(); addToCart('${productItem.id}');" class="bg-emerald-50 text-emerald-600 px-3 py-2 rounded-lg hover:bg-emerald-100 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>`
                  : ""
              }
            </div>
          </div>
        </a>`;
      return productElement;
    }

    function renderProductCards(container, productItems) {
      container.innerHTML = "";
      productItems.forEach((productItem) => {
        const cardElement = buildProductCardElement(productItem);
        container.appendChild(cardElement);
      });
      lucide.createIcons();
    }

    function updateFilterButtonsAppearance() {
      // Ownership filters
      filterButtons.forEach((button) => {
        const filterValue = button.getAttribute("data-filter-value");
        if (filterValue === activeOwnershipFilter) {
          button.className =
            "filter-btn bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium transition-colors hover:bg-emerald-600";
        } else {
          button.className =
            "filter-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg font-medium transition-colors hover:bg-emerald-500 hover:text-white";
        }
      });

      // Category filters
      categoryFilterButtons.forEach((button) => {
        const filterValue = button.getAttribute("data-filter-value");
        if (filterValue === activeCategoryFilter) {
          button.className =
            "filter-btn-category bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full font-medium text-sm transition-colors hover:bg-emerald-200";
        } else {
          button.className =
            "filter-btn-category bg-white text-gray-600 px-3 py-1 rounded-full font-medium text-sm transition-colors hover:bg-emerald-100";
        }
      });
    }

    function filterAndDisplayProducts() {
      updateFilterButtonsAppearance();

      let filteredProducts = allProductsData;

      // Filter by ownership
      if (activeOwnershipFilter === "my") {
        filteredProducts = filteredProducts.filter(
          (p) => Number(p.user_id) === Number(CURRENT_USER_ID)
        );
      }

      // Filter by category
      if (activeCategoryFilter !== "ALL") {
        filteredProducts = filteredProducts.filter((p) => p.category === activeCategoryFilter);
      }

      if (filteredProducts.length === 0) {
        displayPageSection({ showEmpty: true });
      } else {
        renderProductCards(productGridContainer, filteredProducts);
        displayPageSection({ showGrid: true });
      }
    }

    async function fetchProductsFromServer() {
      try {
        displayPageSection({ showLoading: true });
        const response = await fetch(PRODUCT_API_ENDPOINT);
        if (!response.ok) throw new Error("Network response was not ok.");
        const productData = await response.json();
        allProductsData = productData || [];

        const featuredProducts = allProductsData.filter((p) => p.is_featured);
        renderProductCards(featuredGridContainer, featuredProducts);

        filterAndDisplayProducts();
      } catch (error) {
        console.error("Error loading products:", error);
        displayPageSection({ showError: true });
      }
    }

    window.addToCart = async function (productId) {
      try {
        const response = await fetch(`/add-to-cart/${productId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        const result = await response.json();
        if (result.status === "success") {
          showToast("Success", "Product added to cart!", "success");
          cartCount.innerText = result.cart_total;
        } else {
          showToast("Error", result.message || "An error occurred.", "error");
        }
      } catch (error) {
        showToast("Error", "An unexpected network error occurred.", "error");
      }
    };

    // --- EVENT LISTENERS ---
    productForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const productId = formData.get("productId");
      const isEdit = productId && productId !== "";
      const url = isEdit ? `${EDIT_PRODUCT_BASE_URL}${productId}/` : ADD_PRODUCT_URL;

      try {
        const response = await fetch(url, {
          method: "POST",
          body: new URLSearchParams(formData),
          headers: {
            "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        const result = await response.json();
        if (result.status === "success") {
          hideModal();
          showToast("Success", `Product ${isEdit ? "updated" : "added"} successfully!`, "success");
          fetchProductsFromServer();
        } else {
          showToast("Error", result.message || "An error occurred.", "error");
        }
      } catch (error) {
        showToast("Error", "An unexpected network error occurred.", "error");
      }
    });

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        activeOwnershipFilter = button.getAttribute("data-filter-value");
        filterAndDisplayProducts();
      });
    });

    categoryFilterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        activeCategoryFilter = button.getAttribute("data-filter-value");
        filterAndDisplayProducts();
      });
    });

    function openDeleteModal(productId) {
      showDeleteModal();
      const confirmDeleteButton = document.getElementById("confirmDeleteButton");
      confirmDeleteButton.onclick = async function () {
        const url = `/product/delete/${productId}/`;
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
              "X-Requested-With": "XMLHttpRequest",
            },
          });
          const result = await response.json();
          if (result.status === "success") {
            hideDeleteModal();
            showToast("Success", "Product deleted successfully!", "success");
            fetchProductsFromServer();
          } else {
            hideDeleteModal();
            showToast("Error", result.message || "An error occurred.", "error");
          }
        } catch (error) {
          hideDeleteModal();
          showToast("Error", "An unexpected network error occurred.", "error");
        }
      };
    }

    function openEditModal(productId) {
      const product = allProductsData.find((p) => p.id === productId);
      if (!product) {
        showToast("Error", "Product not found.", "error");
        return;
      }
      const productForm = document.getElementById("productForm");
      productForm.reset();
      document.getElementById("productId").value = product.id;
      document.getElementById("name").value = product.name;
      document.getElementById("price").value = product.price;
      document.getElementById("description").value = product.description;
      document.getElementById("category").value = product.category;
      document.getElementById("thumbnail").value = product.thumbnail;
      document.getElementById("stock").value = product.stock;
      document.getElementById("is_featured").checked = product.is_featured;

      document.getElementById("modal-title").innerText = "Edit Product";
      document.getElementById("modal-description").innerText = "Update the details of the product.";
      document.getElementById("submitProduct").innerText = "Save Changes";
      document
        .getElementById("submitProduct")
        .classList.remove("bg-emerald-500", "hover:bg-emerald-600");
      document
        .getElementById("submitProduct")
        .classList.add("bg-indigo-500", "hover:bg-indigo-600");
      showModal();
    }

    function handleGridClick(event) {
      const button = event.target.closest("[data-action]");
      if (!button) return;

      const action = button.dataset.action;
      const productId = button.dataset.productId;

      if (!action || !productId) return;

      event.preventDefault();
      event.stopPropagation();

      if (action === "edit") {
        openEditModal(productId);
      } else if (action === "delete") {
        openDeleteModal(productId);
      }
    }

    document.body.addEventListener("click", handleGridClick);

    // --- INITIALIZATION ---
    fetchProductsFromServer();
  });
</script>
{% endblock scripts %}
